[{"id":"133cbb60.ecc345","type":"sqlitedb","db":"all_database"},{"id":"2d507cf.fd2af84","type":"function","name":"DROP","func":" \nmsg.topic =\n\t\"DROP TABLE \" + msg.payload.table_name + \";\";\n\nreturn msg","outputs":1,"x":476.4722328186035,"y":622.0000114440918,"z":"c8e4c57d.371b38","wires":[["c1d0ac35.3e2f5"]]},{"id":"4b1714d0.b4e8ec","type":"function","name":"CREATE","func":"msg.topic = \n\t\t\"create table if not exists \" + msg.payload.table_name +\n\t\t \" \" + msg.payload.table_parameter\n\t\t//+\"(UserId integer NOT NULL UNIQUE, \"\n\t\t//+\"Intake integer DEFAULT 0);\"\n\nreturn msg","outputs":1,"x":485.47222900390625,"y":249,"z":"c8e4c57d.371b38","wires":[["c1d0ac35.3e2f5"]]},{"id":"d5818db8.2a7e7","type":"http in","name":"SELECT","url":"/sqlite/select","method":"get","x":70.5,"y":174.11111450195312,"z":"c8e4c57d.371b38","wires":[["1de79ad0.e21865"]]},{"id":"c1d0ac35.3e2f5","type":"sqlite","mydb":"133cbb60.ecc345","name":"all database","x":815,"y":350,"z":"c8e4c57d.371b38","wires":[["ef9ce92f.106318","7e8a20c2.8175e"]]},{"id":"5b57c1ae.a4a84","type":"http in","name":"CREATE","url":"/sqlite/create","method":"post","x":68,"y":251,"z":"c8e4c57d.371b38","wires":[["237e2c1b.dc81d4"]]},{"id":"f301b182.0cfe5","type":"http in","name":"UPDATE","url":"/sqlite/update","method":"put","x":74,"y":453,"z":"c8e4c57d.371b38","wires":[["e0cfd8f0.1f3028"]]},{"id":"73d85b93.8c27a4","type":"http in","name":"INSERT","url":"/sqlite/insert","method":"post","x":66,"y":340,"z":"c8e4c57d.371b38","wires":[["a42c8088.5bd38"]]},{"id":"1099a36d.ef665d","type":"http in","name":"DELETE","url":"/sqlite/delete","method":"delete","x":71.25,"y":546.7500076293945,"z":"c8e4c57d.371b38","wires":[["b76660cf.4899a"]]},{"id":"d9468b5d.26b978","type":"http in","name":"DROP","url":"/sqlite/drop","method":"delete","x":69.25,"y":621.7500095367432,"z":"c8e4c57d.371b38","wires":[["6549f47.f9ab60c"]]},{"id":"c226d555.3dd928","type":"function","name":"INSERT","func":"msg.topic = \n\t\t\"INSERT INTO \" + msg.payload.table_name\t\t+ \n\t\tmsg.payload.col_query + \" values \" + \n\t\tmsg.payload.val_query;\n\nreturn msg;","outputs":1,"x":481,"y":340,"z":"c8e4c57d.371b38","wires":[["c1d0ac35.3e2f5","72a7b57b.8d584c"]]},{"id":"56fa9e7a.a9056","type":"function","name":"UPDATE","func":"msg.topic = \n\t\t\"UPDATE \" + msg.payload.table_name\n\t\t+ \" SET \" + msg.payload.update_query\n\nif(msg.payload.where_query)\n\tmsg.topic += \" where \" + msg.payload.where_query;\n\nreturn msg","outputs":1,"x":481.75000762939453,"y":454.7500066757202,"z":"c8e4c57d.371b38","wires":[["c1d0ac35.3e2f5","72a7b57b.8d584c"]]},{"id":"80dc1861.7f23e8","type":"function","name":"DELETE","func":"msg.topic = \t\"DELETE FROM \" + msg.payload.table_name;\n\nif(msg.payload.where_query)\n\tmsg.topic += \" WHERE \" + msg.payload.where_query; \n\nreturn msg;","outputs":1,"x":478.25000762939453,"y":546.7500076293945,"z":"c8e4c57d.371b38","wires":[["c1d0ac35.3e2f5"]]},{"id":"ef9ce92f.106318","type":"function","name":"http_response_formatter","func":"if(msg.payload.length > 0){ \n\tmsg.statusCode = 200;\n}\nelse\n\tmsg.statusCode = 404;\n\nmsg.headers = {\n\t\"content-type\":\"application/javascript\"\n} \n\nreturn msg;","outputs":1,"x":1068,"y":350,"z":"c8e4c57d.371b38","wires":[["d6857cf8.297a8"]]},{"id":"32092207.cdf6de","type":"function","name":"SELECT_ONE","func":"msg.topic += \" LIMIT 1\"; \n\nreturn msg","outputs":1,"x":649.5,"y":120.88888549804688,"z":"c8e4c57d.371b38","wires":[["c1d0ac35.3e2f5"]]},{"id":"be5b7e4a.41a48","type":"inject","name":"DROP","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":782,"y":629,"z":"c8e4c57d.371b38","wires":[["286af81c.d79508"]]},{"id":"a10ff1b1.5ef01","type":"inject","name":"","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":true,"x":781.4444427490234,"y":545.1111128330231,"z":"c8e4c57d.371b38","wires":[["64c2f8d6.9b3d08"]]},{"id":"64c2f8d6.9b3d08","type":"function","name":"InitConst","func":"context.global.sqlTableName = \"IntakeToday\"\n\nreturn { payload: context }","outputs":"1","x":959.2222290039062,"y":544.0000009536743,"z":"c8e4c57d.371b38","wires":[[]]},{"id":"286af81c.d79508","type":"function","name":"Drop","func":"var table_name = context.global.sqlTableName\n\nconsole.log(\"table exists\")\ndrop = {\n\ttopic: \"DROP TABLE \"+table_name+\";\"\n}\n\nreturn drop","outputs":1,"x":949,"y":628,"z":"c8e4c57d.371b38","wires":[["91fc392d.6e03c8"]]},{"id":"d2420fda.2dbdf","type":"inject","name":"CREATE","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":782,"y":667,"z":"c8e4c57d.371b38","wires":[["446ac60.fbb9538"]]},{"id":"446ac60.fbb9538","type":"function","name":"Create","func":"var table_name = context.global.sqlTableName\n\ncreate = {\n\ttopic: \n\t\t\"CREATE TABLE \"+table_name\n\t\t+\"(UserId integer NOT NULL UNIQUE, \"\n\t\t+\"Intake integer DEFAULT 0);\"\n}\n\nreturn create","outputs":1,"x":948,"y":669,"z":"c8e4c57d.371b38","wires":[["91fc392d.6e03c8"]]},{"id":"4326bc51.bcd944","type":"inject","name":"","topic":"SELECT * FROM test_table","payload":"","payloadType":"string","repeat":"","crontab":"","once":false,"x":848.6666793823242,"y":589.333338022232,"z":"c8e4c57d.371b38","wires":[["91fc392d.6e03c8"]]},{"id":"fc972e75.0368d","type":"inject","name":"INSERT","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":781.7777786254883,"y":715.1111166477203,"z":"c8e4c57d.371b38","wires":[["a8ef4838.5710b8"]]},{"id":"a8ef4838.5710b8","type":"function","name":"Insert","func":"var table_name = context.global.sqlTableName\n\ncreate = {\n\ttopic: \n\t\t\"insert into \" + table_name\t\t+\n\t\t\"(UserId, Intake) values ('1','1')\"\n}\n\nreturn create","outputs":1,"x":947.7777786254883,"y":717.1111166477203,"z":"c8e4c57d.371b38","wires":[["91fc392d.6e03c8"]]},{"id":"91fc392d.6e03c8","type":"sqlite","mydb":"133cbb60.ecc345","name":"","x":1240.22220993042,"y":611.2222235202789,"z":"c8e4c57d.371b38","wires":[["6396ec32.9c6914"]]},{"id":"6396ec32.9c6914","type":"debug","name":"","active":true,"console":"false","complete":"false","x":1432.6666641235352,"y":606.4444448947906,"z":"c8e4c57d.371b38","wires":[]},{"id":"7e8a20c2.8175e","type":"debug","name":"","active":false,"console":"false","complete":"true","x":993,"y":206,"z":"c8e4c57d.371b38","wires":[]},{"id":"d6857cf8.297a8","type":"function","name":"publish","func":"// set the header\nfor(var head in msg.headers){\n\tmsg.res.set(head, msg.headers[head]);\n}\n\n// send the http response\nmsg.res.send(msg.statusCode, msg.payload);\n\n// it has to return something\nreturn msg;","outputs":1,"x":1315.888916015625,"y":350.4444274902344,"z":"c8e4c57d.371b38","wires":[[]]},{"id":"347727a9.cb88d8","type":"function","name":"SELECT","func":"var table_name = msg.payload.table_name;\nvar where_query = msg.payload.where_query;\n \nvar query = \"select * from \" + table_name + \" \" \nif(where_query)\t\n\tquery += \" where \" + where_query ; \n\t\nmsg.topic = query \n\n// select one\nif(msg.req.path.indexOf(\"_one\"))\n{\n\treturn [null, msg]; \n} else {\n// select all\n\treturn [msg,null];\n}\n","outputs":"2","x":481,"y":173,"z":"c8e4c57d.371b38","wires":[["32092207.cdf6de"],["c1d0ac35.3e2f5"]]},{"id":"1de79ad0.e21865","type":"function","name":"params_parser","func":"var params = msg.req.query; \n \nvar where_query = \"\"; \nif(typeof(params.where) != \"undefined\"){\n\tvar where_params = JSON.parse(params.where) \n\t\t\n\tfor(var i = 0; i < where_params.length; i++){\n\t\twhere_query += where_params[i].col + \" \";\n\t\twhere_query += where_params[i].op + \" \";\n\t\twhere_query += where_params[i].val + \" \";\t\n\t\tif(typeof(where_params[i].chain_op) != \"undefined\")\n\t\t\twhere_query += where_params[i].chain_op + \" \";\n\t} \n}\n\nmsg.payload = {\n\ttable_name: params.table_name,\n\twhere_query: where_query \n}\n\nreturn msg;","outputs":1,"x":274,"y":174,"z":"c8e4c57d.371b38","wires":[["347727a9.cb88d8"]]},{"id":"742895af.8bd76c","type":"http in","name":"SELECT_ONE","url":"/sqlite/select_one","method":"get","x":88,"y":115,"z":"c8e4c57d.371b38","wires":[[]]},{"id":"237e2c1b.dc81d4","type":"function","name":"params_parser","func":"var params = msg.req.body; \n\nvar table_params = {};\nvar table_param_query = \"\";\n \nif(typeof(params.table_params) != \"undefined\")\n{ \n\ttable_params = JSON.parse(params.table_params) \n\t\t\n\tfor(var i = 0; i < table_params.length; i++){\n\t\ttable_param_query += table_params[i].col + \" \";\n\t\ttable_param_query += table_params[i].type + \" \";\n\t\ttable_param_query += table_params[i].option + \" \";\t\n\t\tif(i < table_params.length - 1)\n\t\t\ttable_param_query += \", \";\n\t} \n}\n\nmsg.payload.\ttable_name = params.table_name;\nmsg.payload.table_parameter = \"(\" + table_param_query + \")\";\n\nreturn msg;","outputs":1,"x":274,"y":250,"z":"c8e4c57d.371b38","wires":[["4b1714d0.b4e8ec"]]},{"id":"85219b83.7ade68","type":"comment","name":"commands","info":"GET /sqlite/select or /sqlite/select_one\nurl parameter:\n1. table_name (string)\n2. where (json string) e.g.: \n[{\n  col:\"username\", op:\"like\", val:\"%test%\", chain_op:\"or\"\n},{...}]\n\nPOST /sqlite/create\nx-www-form-url-encoded\n1. table_name (string)\n2. table_params (json string) e.g.: \n[{  \n  col:\"UserId\", type:\"integer\", option:\"NOT NULL UNIQUE\" \n},{...}]\n\nPOST /sqlite/insert\nx-www-form-url-encoded\n1. table_name (string)\n2. cols (json array) e.g.: [user_id, username]\n3. vals (json array) e.g.: [1,'user_a']\n\nPOST /sqlite/update\nx-www-form-url-encoded\n1. table_name (string)\n2. cols (json array) e.g.: [user_id, username]\n3. vals (json array) e.g.: [1,'user_a']\n4. where (json string) e.g.: \n[{\n  col:\"username\", op:\"like\", val:\"%test%\", chain_op:\"or\"\n},{...}]\n\nDELETE /sqlite/delete\nurl parameter\n1. table_name (string) \n2. where (json string) e.g.: \n[{\n  col:\"username\", op:\"like\", val:\"%test%\", chain_op:\"or\"\n},{...}]\n\nDROP /sqlite/drop\nurl parameter\n1. table_name (string)  ","x":492,"y":47,"z":"c8e4c57d.371b38","wires":[]},{"id":"a42c8088.5bd38","type":"function","name":"params_parser","func":"var params = msg.req.body; \n \nvar col_query = \"\";\nvar val_query = \"\";\n\nif(typeof(params.cols) != \"undefined\")\n{ \n\tvar columns = JSON.parse(params.cols) \n\t\t\n\tfor(var i = 0; i < columns.length; i++){\n\t\tcol_query += columns[i] + \" \";\t\n\t\tif(i < columns.length - 1)\n\t\t\tcol_query += \", \";\n\t} \n}\n\nif(typeof(params.vals) != \"undefined\")\n{ \n\tvar values = JSON.parse(params.vals) \n\t\t\n\tfor(var i = 0; i < values.length; i++){\n\t\tval_query += \"'\" + values[i] + \"'\";\t\n\t\tif(i < values.length - 1)\n\t\t\tval_query += \", \";\n\t} \n}\n\nmsg.payload.\ttable_name = params.table_name;\nmsg.payload.col_query = \"(\" + col_query + \")\";\nmsg.payload.val_query = \"(\" + val_query + \")\";\n\nreturn msg;","outputs":1,"x":273,"y":340,"z":"c8e4c57d.371b38","wires":[["c226d555.3dd928"]]},{"id":"6d8165ea.927e9c","type":"debug","name":"","active":true,"console":"false","complete":"true","x":474.50000762939453,"y":502.7500057220459,"z":"c8e4c57d.371b38","wires":[]},{"id":"72a7b57b.8d584c","type":"debug","name":"","active":true,"console":"false","complete":"true","x":803,"y":261,"z":"c8e4c57d.371b38","wires":[]},{"id":"e0cfd8f0.1f3028","type":"function","name":"params_parser","func":"var params = msg.req.body;\n\nvar update_query = \"\"; \nvar where_query = \"\"; \n\nif(typeof(params.cols) != \"undefined\")\n{  \n\tvar columns = JSON.parse(params.cols); \n\tvar values = JSON.parse(params.vals);\n\t\n\tfor(var i = 0; i < columns.length; i++){\n\t\tupdate_query += columns[i] + \" = \";\n\t\tupdate_query += values[i] + \" \";\n\t\t\n\t\tif(i < columns.length - 1)\n\t\t\tupdate_query += \", \";\n\t} \n}\n  \nif(typeof(params.where) != \"undefined\"){\n\tvar where_params = JSON.parse(params.where) \n\t\t\n\tfor(var i = 0; i < where_params.length; i++){\n\t\twhere_query += where_params[i].col + \" \";\n\t\twhere_query += where_params[i].op + \" \";\n\t\twhere_query += where_params[i].val + \" \";\t\n\t\tif(typeof(where_params[i].chain_op) != \"undefined\")\n\t\t\twhere_query += where_params[i].chain_op + \" \";\n\t} \n}\n\n// the object msg.payload doesnt exist here yet\nmsg.payload = {}\nmsg.payload.update_query = update_query; \nmsg.payload.where_query = where_query;\nmsg.payload.\ttable_name = \"\"+params.table_name;\n\nreturn msg;","outputs":1,"x":265.00000381469727,"y":453.7500057220459,"z":"c8e4c57d.371b38","wires":[["56fa9e7a.a9056"]]},{"id":"b76660cf.4899a","type":"function","name":"params_parser","func":"var params = msg.req.query; \n \nvar where_query = \"\"; \n \nif(typeof(params.where) != \"undefined\"){\n\tvar where_params = JSON.parse(params.where) \n\t\t\n\tfor(var i = 0; i < where_params.length; i++){\n\t\twhere_query += where_params[i].col + \" \";\n\t\twhere_query += where_params[i].op + \" \";\n\t\twhere_query += where_params[i].val + \" \";\t\n\t\tif(typeof(where_params[i].chain_op) != \"undefined\")\n\t\t\twhere_query += where_params[i].chain_op + \" \";\n\t} \n}\n\n// the object msg.payload doesnt exist here yet\nmsg.payload = {}\nmsg.payload.\ttable_name = params.table_name; \nmsg.payload.where_query = where_query;\n\nreturn msg;","outputs":1,"x":262.5,"y":546.2500076293945,"z":"c8e4c57d.371b38","wires":[["80dc1861.7f23e8","6d8165ea.927e9c"]]},{"id":"6549f47.f9ab60c","type":"function","name":"params_parser","func":"var params = msg.req.query;\n   \n// the object msg.payload doesnt exist here yet\nmsg.payload = {}\nmsg.payload.\ttable_name = params.table_name;  \n\nreturn msg;","outputs":1,"x":262.50000381469727,"y":622.5000095367432,"z":"c8e4c57d.371b38","wires":[["2d507cf.fd2af84","6d8165ea.927e9c"]]}]